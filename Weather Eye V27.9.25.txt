#include <ESP8266WiFi.h>
#include <DNSServer.h>
#include <DHT.h>

#define DHTPIN D4       // DHT11 data pin
#define DHTTYPE DHT11

DHT dht(DHTPIN, DHTTYPE);

const byte DNS_PORT = 53;
DNSServer dnsServer;

const char *ssid = "Weather Eye";
const char *password = "12345678";

WiFiServer server(80);

float temperature, humidity, feelsLike;
bool dhtActive = false;
unsigned long lastUpdate = 0;
unsigned long lastSuccessfulUpdate = 0;
const long updateInterval = 1000; // Update every 1 second (instant)

// Compute "Feels Like" temperature (Heat Index formula)
float computeFeelsLike(float T, float H) {
  float hi = -8.784695 + 
              1.61139411 * T + 
              2.338549 * H + 
             -0.14611605 * T * H + 
             -0.012308094 * pow(T, 2) + 
             -0.016424828 * pow(H, 2) + 
              0.002211732 * pow(T, 2) * H + 
              0.00072546 * T * pow(H, 2) + 
             -0.000003582 * pow(T, 2) * pow(H, 2);
  return hi;
}

// Convert Celsius to Fahrenheit
float celsiusToFahrenheit(float celsius) {
  return (celsius * 9.0 / 5.0) + 32.0;
}

// Convert Celsius to Kelvin
float celsiusToKelvin(float celsius) {
  return celsius + 273.15;
}

String getLastUpdateTime() {
  if (lastSuccessfulUpdate == 0) {
    return "00h 00m 00s";
  }
  
  unsigned long secondsSinceUpdate = (millis() - lastSuccessfulUpdate) / 1000;
  unsigned long hours = secondsSinceUpdate / 3600;
  unsigned long minutes = (secondsSinceUpdate % 3600) / 60;
  unsigned long seconds = secondsSinceUpdate % 60;
  
  char timeString[20];
  sprintf(timeString, "%02luh %02lum %02lus", hours, minutes, seconds);
  return String(timeString);
}

String getLastDataString() {
  if (!dhtActive) {
    return "T=N/A   H=N/A   HIA=N/A";
  }
  
  char dataString[50];
  sprintf(dataString, "T=%.1f°C   H=%.1f%%   HIA=%.1f°C", temperature, humidity, feelsLike);
  return String(dataString);
}

String getTemperatureScales() {
  if (!dhtActive) {
    return "N/A";
  }
  
  float fahrenheit = celsiusToFahrenheit(temperature);
  float kelvin = celsiusToKelvin(temperature);
  
  char scaleString[50];
  sprintf(scaleString, "%.1f°F | %.1fK", fahrenheit, kelvin);
  return String(scaleString);
}

String getDHTStatus() {
  return dhtActive ? "ACTIVE" : "ERROR";
}

String getDHTStatusColor() {
  return dhtActive ? "#00ff00" : "#ff5555";
}

String formatValue(float value) {
  if (isnan(value) || !dhtActive) {
    return "N/A";
  }
  return String(value, 1);
}

String webpage() {
  String page = R"=====(
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEATHER EYE TERMINAL</title>
    <style>
      :root {
        --main-bg-color: #0a0a12;
        --terminal-green: #00ff00;
        --terminal-cyan: #00ffff;
        --terminal-yellow: #ffff00;
        --terminal-red: #ff5555;
        --terminal-purple: #aa00ff;
        --glow-color: rgba(0, 255, 255, 0.7);
      }
      
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Courier New', monospace;
      }
      
      body {
        background-color: var(--main-bg-color);
        color: var(--terminal-green);
        overflow-x: hidden;
        min-height: 100vh;
        padding: 20px;
        position: relative;
      }
      
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
          radial-gradient(circle at 10% 20%, rgba(0, 255, 255, 0.05) 0%, transparent 20%),
          radial-gradient(circle at 90% 80%, rgba(170, 0, 255, 0.05) 0%, transparent 20%);
        pointer-events: none;
        z-index: -1;
      }
      
      .scan-line {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(to right, transparent, var(--terminal-cyan), transparent);
        box-shadow: 0 0 10px var(--glow-color);
        animation: scan 3s linear infinite;
        z-index: 999;
        pointer-events: none;
      }
      
      @keyframes scan {
        0% { top: 0%; }
        100% { top: 100vh; }
      }
      
      .noise {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        opacity: 0.1;
        pointer-events: none;
        z-index: -1;
      }
      
      .terminal {
        max-width: 800px;
        margin: 30px auto;
        border: 1px solid var(--terminal-cyan);
        border-radius: 5px;
        box-shadow: 0 0 15px var(--glow-color),
                    inset 0 0 20px rgba(0, 255, 255, 0.1);
        overflow: hidden;
        background-color: rgba(10, 10, 18, 0.95);
      }
      
      .terminal-header {
        background: linear-gradient(to right, #001122, #002244);
        padding: 10px 15px;
        border-bottom: 1px solid var(--terminal-cyan);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .terminal-title {
        font-weight: bold;
        color: var(--terminal-cyan);
        text-shadow: 0 0 5px var(--glow-color);
      }
      
      .terminal-controls {
        display: flex;
      }
      
      .control {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-left: 8px;
      }
      
      .control.close { background-color: var(--terminal-red); }
      .control.minimize { background-color: var(--terminal-yellow); }
      .control.maximize { background-color: var(--terminal-green); }
      
      .terminal-body {
        padding: 20px;
      }
      
      .prompt {
        color: var(--terminal-purple);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }
      
      .prompt::before {
        content: "> ";
        color: var(--terminal-yellow);
        font-weight: bold;
      }
      
      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 25px 0;
      }
      
      .data-card {
        background: rgba(0, 20, 40, 0.3);
        border: 1px solid rgba(0, 255, 255, 0.3);
        border-radius: 4px;
        padding: 15px;
        position: relative;
        overflow: hidden;
      }
      
      .data-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(to right, transparent, var(--terminal-cyan), transparent);
      }
      
      .data-label {
        color: var(--terminal-cyan);
        font-size: 0.9rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      
      .data-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--terminal-green);
        text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
      }
      
      .temperature-scales {
        font-size: 0.9rem;
        color: var(--terminal-yellow);
        margin-top: 5px;
      }
      
      .na-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--terminal-red);
        text-shadow: 0 0 5px rgba(255, 85, 85, 0.5);
      }
      
      .data-unit {
        font-size: 1rem;
        color: var(--terminal-yellow);
        margin-left: 5px;
      }
      
      .status-bar {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
        padding-top: 10px;
        border-top: 1px dashed rgba(0, 255, 255, 0.3);
        font-size: 0.8rem;
        color: var(--terminal-purple);
      }
      
      .blink {
        animation: blink 1s step-start infinite;
      }
      
      @keyframes blink {
        50% { opacity: 0; }
      }
      
      .command-line {
        margin-top: 20px;
        display: flex;
        align-items: center;
      }
      
      .command-prompt {
        color: var(--terminal-yellow);
        margin-right: 10px;
      }
      
      .command-input {
        background: transparent;
        border: none;
        color: var(--terminal-green);
        font-family: 'Courier New', monospace;
        width: 100%;
        outline: none;
        caret-color: var(--terminal-cyan);
      }
      
      .hex-pattern {
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 0.7rem;
        color: rgba(0, 255, 255, 0.3);
        writing-mode: vertical-rl;
        text-orientation: mixed;
      }
      
      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
      }
      
      .last-data {
        background: rgba(0, 40, 80, 0.3);
        border: 1px solid rgba(0, 255, 255, 0.2);
        border-radius: 4px;
        padding: 10px 15px;
        margin: 15px 0;
        font-family: 'Courier New', monospace;
        color: var(--terminal-cyan);
      }
      
      @media (max-width: 600px) {
        .data-grid {
          grid-template-columns: 1fr;
        }
        
        .terminal {
          margin: 10px;
        }
        
        .last-data {
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="scan-line"></div>
    <div class="noise"></div>
    
    <div class="terminal">
      <div class="terminal-header">
        <div class="terminal-title">WEATHER EYE TERMINAL v27.9.25.2.O</div>
        <div class="terminal-controls">
          <div class="control close"></div>
          <div class="control minimize"></div>
          <div class="control maximize"></div>
        </div>
      </div>
      
      <div class="terminal-body">
        <div class="prompt">DHT11 STATUS: <span class="status-indicator" style="background-color: )=====" + String(getDHTStatusColor()) + R"=====(;"></span><span id="dhtStatus">)=====" + String(getDHTStatus()) + R"=====(</span></div>
        
        <div class="data-grid">
          <div class="data-card">
            <div class="data-label">TEMPERATURE SENSOR</div>
            <div class=")=====" + (dhtActive ? "data-value" : "na-value") + R"=====("><span id="temperature">)=====" + formatValue(temperature) + R"=====(</span>)=====" + (dhtActive ? "<span class=\"data-unit\">°C</span>" : "") + R"=====(</div>
            <div class="temperature-scales" id="temperatureScales">)=====" + getTemperatureScales() + R"=====(</div>
            <div class="data-label">STATUS: )=====" + (dhtActive ? "NOMINAL" : "DISCONNECTED") + R"=====(</div>
          </div>
          
          <div class="data-card">
            <div class="data-label">HUMIDITY SENSOR</div>
            <div class=")=====" + (dhtActive ? "data-value" : "na-value") + R"=====("><span id="humidity">)=====" + formatValue(humidity) + R"=====(</span>)=====" + (dhtActive ? "<span class=\"data-unit\">%</span>" : "") + R"=====(</div>
            <div class="data-label">STATUS: )=====" + (dhtActive ? "NOMINAL" : "DISCONNECTED") + R"=====(</div>
          </div>
          
          <div class="data-card">
            <div class="data-label">HEAT INDEX ANALYSIS</div>
            <div class=")=====" + (dhtActive ? "data-value" : "na-value") + R"=====("><span id="feelsLike">)=====" + formatValue(feelsLike) + R"=====(</span>)=====" + (dhtActive ? "<span class=\"data-unit\">°C</span>" : "") + R"=====(</div>
            <div class="data-label">STATUS: )=====" + (dhtActive ? "WITHIN PARAMETERS" : "UNAVAILABLE") + R"=====(</div>
          </div>
        </div>
        
        <div class="last-data">
          <div style="color: var(--terminal-yellow); margin-bottom: 5px;">LAST DATA:</div>
          <div id="lastDataString">)=====" + getLastDataString() + R"=====(</div>
        </div>
        
        <div class="prompt">LAST UPDATE: <span id="lastUpdate">)=====" + getLastUpdateTime() + R"=====(</span> AGO</div>
        
        <div class="status-bar">
          <div>MAKER: MD SAFAYATH CHOWDHURY</div>
          <div>REFRESH: <span class="blink">1s</span></div>
        </div>
        
        <div class="command-line">
          <span class="command-prompt">>></span>
          <input type="text" class="command-input" value="monitor --continuous --sensors=all" disabled>
        </div>
      </div>
    </div>
    
    <div class="hex-pattern">0F A3 7C E9 1B 44 82 D5 39 F0 6A BD 27 9E 53 C8</div>

    <script>
      // Update values using AJAX
      function updateValues() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            var data = JSON.parse(this.responseText);
            
            // Update temperature
            if (data.dhtStatus === "ACTIVE") {
              document.getElementById("temperature").innerText = data.temperature.toFixed(1);
              document.getElementById("temperature").parentElement.className = "data-value";
              document.querySelectorAll(".data-card .data-label")[0].innerHTML = "STATUS: NOMINAL";
              document.getElementById("temperatureScales").innerText = data.temperatureScales;
            } else {
              document.getElementById("temperature").innerText = "N/A";
              document.getElementById("temperature").parentElement.className = "na-value";
              document.querySelectorAll(".data-card .data-label")[0].innerHTML = "STATUS: DISCONNECTED";
              document.getElementById("temperatureScales").innerText = "N/A";
            }
            
            // Update humidity
            if (data.dhtStatus === "ACTIVE") {
              document.getElementById("humidity").innerText = data.humidity.toFixed(1);
              document.getElementById("humidity").parentElement.className = "data-value";
              document.querySelectorAll(".data-card .data-label")[1].innerHTML = "STATUS: NOMINAL";
            } else {
              document.getElementById("humidity").innerText = "N/A";
              document.getElementById("humidity").parentElement.className = "na-value";
              document.querySelectorAll(".data-card .data-label")[1].innerHTML = "STATUS: DISCONNECTED";
            }
            
            // Update feels like
            if (data.dhtStatus === "ACTIVE") {
              document.getElementById("feelsLike").innerText = data.feelsLike.toFixed(1);
              document.getElementById("feelsLike").parentElement.className = "data-value";
              document.querySelectorAll(".data-card .data-label")[2].innerHTML = "STATUS: WITHIN PARAMETERS";
            } else {
              document.getElementById("feelsLike").innerText = "N/A";
              document.getElementById("feelsLike").parentElement.className = "na-value";
              document.querySelectorAll(".data-card .data-label")[2].innerHTML = "STATUS: UNAVAILABLE";
            }
            
            // Update last data string
            document.getElementById("lastDataString").innerText = data.lastDataString;
            
            // Update timestamp and status
            document.getElementById("lastUpdate").innerText = data.lastUpdate;
            document.getElementById("dhtStatus").innerText = data.dhtStatus;
            document.querySelector(".status-indicator").style.backgroundColor = data.dhtStatusColor;
          }
        };
        xhr.open("GET", "/data", true);
        xhr.send();
      }
      
      // Update values every 1 second (instant)
      setInterval(updateValues, 1000);
      
      // Initial update
      document.addEventListener('DOMContentLoaded', function() {
        updateValues();
      });
    </script>
  </body>
  </html>
  )=====";
  return page;
}

void setup() {
  Serial.begin(115200);
  dht.begin();

  // Start Access Point
  WiFi.softAP(ssid, password);

  // Captive portal setup (redirect all DNS queries to ESP IP)
  dnsServer.start(DNS_PORT, "*", WiFi.softAPIP());

  server.begin();

  Serial.println("Access Point Started!");
  Serial.print("Connect to WiFi: ");
  Serial.println(ssid);
  Serial.print("IP Address: ");
  Serial.println(WiFi.softAPIP());
}

void loop() {
  dnsServer.processNextRequest(); // Captive portal redirect

  // Update sensor data every 1 second (instant)
  if (millis() - lastUpdate >= updateInterval) {
    // Read DHT11 every cycle (1 second)
    humidity = dht.readHumidity();
    temperature = dht.readTemperature();
    
    // Check if DHT11 is active
    if (isnan(humidity) || isnan(temperature)) {
      dhtActive = false;
      feelsLike = NAN;
    } else {
      dhtActive = true;
      feelsLike = computeFeelsLike(temperature, humidity);
      lastSuccessfulUpdate = millis(); // Update successful read time
    }
    
    lastUpdate = millis();
    
    Serial.print("DHT11 Status: ");
    Serial.println(dhtActive ? "ACTIVE" : "ERROR");
    if (dhtActive) {
      Serial.print("Temperature: ");
      Serial.print(temperature);
      Serial.print("°C (");
      Serial.print(celsiusToFahrenheit(temperature));
      Serial.print("°F, ");
      Serial.print(celsiusToKelvin(temperature));
      Serial.print("K) | Humidity: ");
      Serial.print(humidity);
      Serial.print("% | Feels Like: ");
      Serial.print(feelsLike);
      Serial.println("°C");
    } else {
      Serial.println("DHT11 Sensor Disconnected - Showing N/A");
    }
  }

  WiFiClient client = server.available();
  if (!client) return;

  String request = client.readStringUntil('\r');
  client.flush();

  // Handle data request
  if (request.indexOf("GET /data") != -1) {
    String data = "{\"temperature\":" + String(isnan(temperature) ? "0" : String(temperature)) + 
                  ",\"humidity\":" + String(isnan(humidity) ? "0" : String(humidity)) + 
                  ",\"feelsLike\":" + String(isnan(feelsLike) ? "0" : String(feelsLike)) + 
                  ",\"lastUpdate\":\"" + getLastUpdateTime() + "\"" +
                  ",\"lastDataString\":\"" + getLastDataString() + "\"" +
                  ",\"temperatureScales\":\"" + getTemperatureScales() + "\"" +
                  ",\"dhtStatus\":\"" + getDHTStatus() + "\"" +
                  ",\"dhtStatusColor\":\"" + getDHTStatusColor() + "\"}";
    
    client.println("HTTP/1.1 200 OK");
    client.println("Content-Type: application/json");
    client.println("Connection: close");
    client.println();
    client.println(data);
  } 
  // Handle main page request
  else {
    client.println("HTTP/1.1 200 OK");
    client.println("Content-Type: text/html");
    client.println("Connection: close");
    client.println();
    client.println(webpage());
  }
}